<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Trainer Blindfold V2.0 - AutoSave</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #222;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* --- CONTROLES DU HAUT --- */
        #top-bar {
            background: #333;
            width: 100%;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .row {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            width: 95%;
        }

        button.btn-mode {
            padding: 6px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            background-color: #555;
            color: #ccc;
            font-size: 14px;
        }
        button.btn-mode.active {
            background-color: #3498db;
            color: white;
            box-shadow: 0 0 10px #3498db;
        }

        input[type="text"], select {
            background: #444;
            border: 1px solid #666;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
            font-family: monospace;
            font-size: 13px;
        }
        
        #input-url-sheet {
            width: 250px;
            text-align: left;
            background: #2c3e50;
            border-color: #3498db;
            color: #bdc3c7;
        }

        #config-groupes { width: 200px; text-align: left; }
        #filtre { width: 30px; border-color: #e74c3c; font-weight: bold; }

        /* --- STATUS CONNEXION --- */
        #status-sheet {
            font-size: 11px;
            margin-left: 10px;
            font-weight: bold;
        }
        .status-ok { color: #2ecc71; }
        .status-err { color: #e74c3c; }
        .status-wait { color: #f1c40f; }

        /* --- OPTIONS --- */
        .options-area {
            background: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 13px;
        }
        
        input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: #f1c40f; }
        label { cursor: pointer; font-weight: bold; }
        
        .separator { border-left: 1px solid #666; height: 20px; margin: 0 2px; }

        /* --- ZONE CENTRALE --- */
        #zone-centrale {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            cursor: pointer;
        }

        #affichage {
            font-size: 180px;
            font-weight: 800;
            text-shadow: 0 0 20px rgba(255,255,255,0.1);
            user-select: none;
            line-height: 1;
            margin-bottom: 10px;
        }

        #affichage-mot {
            font-size: 40px;
            color: #f1c40f; 
            font-weight: bold;
            height: 50px;
            text-align: center;
            font-family: 'Courier New', monospace;
            opacity: 0; 
            transition: opacity 0.1s;
            padding: 0 20px;
        }
        
        #affichage-mot.visible { opacity: 1; }

        #infos { color: #777; margin-top: 20px; font-size: 16px; }

        /* --- HISTORIQUE --- */
        #historique-container {
            height: 50px;
            width: 100%;
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            border-top: 1px solid #333;
            color: #555;
            font-family: monospace;
            font-size: 18px;
        }
        .hist-item { animation: fadeIn 0.3s ease; }
        .hist-item:first-child { color: #888; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="top-bar">
        <div class="row">
            <input type="text" id="input-url-sheet" placeholder="Coller le lien Google Sheet (TSV)..." onchange="chargerDictionnaireDepuisGoogle()">
            <span id="status-sheet" class="status-wait">En attente du lien...</span>
        </div>

        <div class="row">
            <button id="btn-arretes" class="btn-mode active" onclick="changerMode('arretes')">ARRÊTES</button>
            <button id="btn-coins" class="btn-mode" onclick="changerMode('coins')">COINS</button>
            
            <input type="text" id="config-groupes" placeholder="Groupes..." oninput="sauvegarderEtMettreAJour()">
            
            <div style="display: flex; gap: 5px; align-items: center; background: #222; padding: 3px; border-radius: 4px; border: 1px solid #555;">
                <span style="font-size: 12px; color: #aaa; padding-left: 5px;">Imp:</span>
                <input type="text" id="filtre" maxlength="1" placeholder="-" oninput="sauvegarderEtMettreAJour()">
                <select id="filtre-pos" onchange="sauvegarderEtMettreAJour()">
                    <option value="any">*</option>
                    <option value="1">1ère</option>
                    <option value="2">2ème</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="options-area">
                <input type="checkbox" id="mode-cycle" onchange="resetCycle()" title="Passe chaque paire une fois avant de répéter"> 
                <label for="mode-cycle" title="Mode Exhaustif">Cycle</label>

                <span class="separator"></span>

                <input type="checkbox" id="mode-verif" checked> 
                <label for="mode-verif">Flashcard</label>
                
                <span class="separator"></span>

                <input type="checkbox" id="auto-mode" onchange="toggleAuto()">
                <label for="auto-mode">Métronome</label>
                <input type="range" id="speed" min="500" max="5000" step="100" value="2000" oninput="saveAndSetSpeed()">
                <span id="speed-label">2.0s</span>
            </div>
            <div id="debug" style="font-size: 12px; color: #555; font-family: monospace;">0 paires</div>
        </div>
    </div>

    <div id="zone-centrale" onclick="document.body.focus()">
        <div id="affichage">GO</div>
        <div id="affichage-mot"></div>
        <div id="infos">Collez votre lien Google Sheet en haut</div>
    </div>

    <div id="historique-container">
        <span style="font-size: 14px;">Historique vide</span>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let dictionnaireMots = {}; 
        
        let data = {
            arretes: "AB CD EF GH IJ KL MN OP QR ST UV",
            coins:   "ABC DEF GHI JKL MNO PQR STU"
        };
        let modeActuel = 'arretes';
        let poolDePaires = [];  // Liste complète possible
        let poolRestant = [];   // Liste pour le mode cycle
        
        let historique = [];
        let intervalId = null; 
        
        let paireActuelle = "";
        let etatVerification = 'ATTENTE_LETTRE'; 

        // --- INIT ---
        window.onload = function() {
            // 1. Récupérer les sauvegardes locales (Groupes, Sheet, Vitesse)
            if(localStorage.getItem("saved_arretes")) data.arretes = localStorage.getItem("saved_arretes");
            if(localStorage.getItem("saved_coins")) data.coins = localStorage.getItem("saved_coins");
            
            const savedUrl = localStorage.getItem("sheetUrl");
            if (savedUrl) {
                document.getElementById("input-url-sheet").value = savedUrl;
                chargerDictionnaireDepuisGoogle();
            }

            const savedSpeed = localStorage.getItem("saved_speed");
            if (savedSpeed) {
                document.getElementById("speed").value = savedSpeed;
                document.getElementById('speed-label').innerText = (savedSpeed / 1000).toFixed(1) + "s";
            }

            // 2. Lancer
            chargerInputs();
            calculerPool();
        };

        // --- GESTION GOOGLE SHEETS ---
        function chargerDictionnaireDepuisGoogle() {
            const url = document.getElementById("input-url-sheet").value.trim();
            const statusSpan = document.getElementById("status-sheet");
            
            if (!url) {
                statusSpan.innerText = "Aucun lien";
                statusSpan.className = "status-wait";
                return;
            }

            localStorage.setItem("sheetUrl", url);
            statusSpan.innerText = "Chargement...";
            statusSpan.className = "status-wait";

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error("Erreur réseau");
                    return response.text();
                })
                .then(text => {
                    const lines = text.split('\n');
                    let count = 0;
                    dictionnaireMots = {}; 

                    lines.forEach(line => {
                        const parts = line.split('\t');
                        if (parts.length >= 2) {
                            const paire = parts[0].trim().toUpperCase();
                            const mot = parts[1].trim();
                            if (paire && mot) {
                                dictionnaireMots[paire] = mot;
                                count++;
                            }
                        }
                    });
                    
                    statusSpan.innerText = "OK ! (" + count + " mots)";
                    statusSpan.className = "status-ok";
                    document.getElementById("infos").innerText = "Prêt ! Appuyez sur Espace";
                })
                .catch(err => {
                    console.error(err);
                    statusSpan.innerText = "Erreur (Lien ?)";
                    statusSpan.className = "status-err";
                });
        }

        // --- LOGIQUE PRINCIPALE ---
        function actionBarreEspace() {
            const modeVerifActif = document.getElementById("mode-verif").checked;

            if (modeVerifActif) {
                if (paireActuelle === "") {
                    genererEtAfficherPaire();
                    return;
                }
                if (etatVerification === 'ATTENTE_LETTRE') {
                    const mot = dictionnaireMots[paireActuelle];
                    const zoneMot = document.getElementById("affichage-mot");
                    
                    if (mot) {
                        zoneMot.innerText = mot;
                        zoneMot.style.color = "#f1c40f";
                    } else {
                        zoneMot.innerText = "(Mot manquant)";
                        zoneMot.style.color = "#777";
                    }
                    zoneMot.classList.add("visible");
                    etatVerification = 'ATTENTE_NEXT'; 
                } else {
                    genererEtAfficherPaire();
                }
            } else {
                genererEtAfficherPaire();
            }
        }

        function genererEtAfficherPaire() {
            if (poolDePaires.length === 0) {
                document.getElementById("affichage").innerText = "!";
                return;
            }

            const zoneMot = document.getElementById("affichage-mot");
            zoneMot.classList.remove("visible");
            zoneMot.innerText = "";
            
            let resultat;
            const cycleActif = document.getElementById("mode-cycle").checked;

            if (cycleActif) {
                if (poolRestant.length === 0) {
                    poolRestant = [...poolDePaires];
                }
                const randomIndex = Math.floor(Math.random() * poolRestant.length);
                resultat = poolRestant[randomIndex];
                poolRestant.splice(randomIndex, 1);
                updateDebugCount();
            } else {
                const random = Math.floor(Math.random() * poolDePaires.length);
                resultat = poolDePaires[random];
            }
            
            paireActuelle = resultat;
            document.getElementById("affichage").innerText = resultat;
            document.getElementById("infos").innerText = ""; 

            historique.unshift(resultat);
            if (historique.length > 10) historique.pop();
            afficherHistorique();

            etatVerification = 'ATTENTE_LETTRE';
        }

        function updateDebugCount() {
            const cycleActif = document.getElementById("mode-cycle").checked;
            if (cycleActif) {
                document.getElementById('debug').innerText = poolRestant.length + " / " + poolDePaires.length;
            } else {
                document.getElementById('debug').innerText = poolDePaires.length + " paires";
            }
        }

        function resetCycle() {
            poolRestant = [...poolDePaires];
            updateDebugCount();
        }

        function afficherHistorique() {
            const container = document.getElementById("historique-container");
            container.innerHTML = "";
            historique.forEach(paire => {
                const span = document.createElement("span");
                span.className = "hist-item";
                span.innerText = paire;
                container.appendChild(span);
            });
        }

        // --- GESTION CONFIGURATION ---
        function changerMode(mode) {
            modeActuel = mode;
            historique = []; 
            paireActuelle = "";
            afficherHistorique();
            
            document.getElementById('affichage-mot').classList.remove("visible");
            document.getElementById('btn-arretes').className = mode === 'arretes' ? 'btn-mode active' : 'btn-mode';
            document.getElementById('btn-coins').className = mode === 'coins' ? 'btn-mode active' : 'btn-mode';
            document.getElementById('affichage').innerText = "GO";
            
            chargerInputs();
            calculerPool();
        }

        function chargerInputs() {
            document.getElementById('config-groupes').value = data[modeActuel];
        }

        function sauvegarderEtMettreAJour() {
            // Mise à jour de la mémoire vive
            data[modeActuel] = document.getElementById('config-groupes').value.toUpperCase();
            
            // SAUVEGARDE PERSISTANTE (LocalStorage)
            localStorage.setItem("saved_" + modeActuel, data[modeActuel]);
            
            calculerPool();
        }

        function calculerPool() {
            const rawText = data[modeActuel];
            const filtre = document.getElementById('filtre').value.toUpperCase();
            const positionFiltre = document.getElementById('filtre-pos').value;

            const groupes = rawText.split(" ").filter(x => x.length > 0);
            const toutesLettres = groupes.join("").split("");
            
            let tempPool = [];

            for (let i = 0; i < toutesLettres.length; i++) {
                for (let j = 0; j < toutesLettres.length; j++) {
                    let L1 = toutesLettres[i];
                    let L2 = toutesLettres[j];

                    if (L1 === L2) continue;
                    
                    let g1 = groupes.find(g => g.includes(L1));
                    let g2 = groupes.find(g => g.includes(L2));
                    if (g1 === g2) continue;

                    if (filtre) {
                        if (positionFiltre === '1' && L1 !== filtre) continue;
                        if (positionFiltre === '2' && L2 !== filtre) continue;
                        if (positionFiltre === 'any' && (L1 !== filtre && L2 !== filtre)) continue;
                    }

                    tempPool.push(L1 + L2);
                }
            }
            poolDePaires = tempPool;
            resetCycle(); 
        }

        // --- GESTION METRONOME ---
        function toggleAuto() {
            const isAuto = document.getElementById('auto-mode').checked;
            if (isAuto) {
                document.getElementById('mode-verif').checked = false;
                lancerMetronome();
                document.getElementById("infos").innerText = "Mode Auto";
            } else {
                clearInterval(intervalId);
                document.getElementById("infos").innerText = "Mode Manuel";
            }
        }

        function saveAndSetSpeed() {
            const ms = document.getElementById('speed').value;
            localStorage.setItem("saved_speed", ms); // Sauvegarde vitesse
            document.getElementById('speed-label').innerText = (ms / 1000).toFixed(1) + "s";
            
            if (document.getElementById('auto-mode').checked) {
                lancerMetronome();
            }
        }

        function lancerMetronome() {
            clearInterval(intervalId);
            const ms = document.getElementById('speed').value;
            intervalId = setInterval(genererEtAfficherPaire, ms);
        }

        // --- INPUT UTILISATEUR ---
        document.body.onkeyup = function(e) {
            if (document.activeElement.tagName === "INPUT") return;

            if (e.code === "Space" || e.keyCode === 32) {
                if (document.getElementById('auto-mode').checked) {
                    document.getElementById('auto-mode').click(); 
                    return;
                }
                actionBarreEspace();
            }
        };
    </script>
</body>
</html>
